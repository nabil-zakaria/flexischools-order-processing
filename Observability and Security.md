# Part 3: Observability & Security

The key components that make up the Flexischools Order Processing system include: an RDS DB, SQS queue, ECS Fargate Service and an Application Load Balancer. The following strategies should be employed in order to ensure these resources are monitored and logged correctly.

## CloudTrail Logs

- CloudTrail logs should be enabled by default in all AWS regions. CloudTrail logs can be used to trace all API actions performed by users or AWS services (via the AWS console or the API). These logs contain detailed information related to what action was performed, by whom/what, when it was made as well as the request details. Enabling CloudTrail logs is essential as they are extremely beneficial when debugging problems impacting the Order Processing service operating in AWS.

## Centralised Monitoring & Logging

- A [CloudWatch Dashboard](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch_Dashboards.html) can be utilised to centralise the display of all metrics and alarms that are configured as part of the Order Processing AWS infrastructure mentioned below.
- If a Splunk instance is available for use, all logs generated by the AWS resources should be streamed to Splunk. Additional infrastructure components (such as Kinesis Firehose) are neccessary to accomplish this task. However, if possible collating all the service logs in one location is very beneficial for troubleshooting.

## RDS Database - Monitoring

- CloudWatch metrics should be used to track the performance of the RDS instance, particularly metrics such as CPUUtilization, FreeableMemory, DatabaseConnections, DiskQueueDepth, and FreeStorageSpace. For even greater visibility regarding performance of the OS that is running on the instance, Enhanced Monitoring can be enabled for real-time metrics gathering.
- CloudWatch Alarms should be configured to raise alerts should specific thresholds be exceeded for specific metrics, such as CPUUtilization, FreeableMemory, DatabaseConnections. These would typically be set after performing load testing of the Order Processing system.

## RDS Database - Logging

- Ensure RDS database logs are enabled and configured to publish to CloudWatch Logs. Given the maximum period before the logs are rotated on the RDS instance is 7 days, exporting to CloudWatch Logs will provide the team with the opportunity to analyse the data contained within after they are cycled on the RDS instance.

## SQS Queue - Monitoring

- A Dead Letter Queue (DLQ) should be configured and used to hold messages that were not able to be processed successfully by the system.
- Amazon CloudWatch metrics can be used to track the health of the queue. Key metrics that are important to observe are:
  - ApproximateAgeOfOldestMessage - This metric provides a good indication of how well the system is processing the messages. If the timestamp of the oldest messages keeps getting older then itâ€™s likely the system is not able to handle all the incoming orders and needs to be scaled up. 
  - ApproximateNumberOfMessagesVisible - This metric gives an indication of how the system is performing in aggregate, showing whether the task processing orders is meeting demand and whether that demand is stable, decreasing, or increasing over time.
- CloudWatch alarms should be configured to raise an alert should the ApproximateAgeOfOldestMessage cross a particular threshold or ApproximateNumberOfMessagesVisible is exceeding the peak number of messages that the system has been tested to process correctly.

## SQS Queue - Logging

- Use CloudTrail logs (which should be enabled globally) to track who/what is performing API actions against the queue.

## ECS Fargate Service - Monitoring

- Enable Container Insights with Enhanced Observability to gain in-depth visibility into the performance of the ECS container environment running the Order Processing tasks through additional CloudWatch metrics.
- Use CloudWatch metrics including Service CPUUtilization, Service MemoryUtilization, Service RunningTaskCount to determine how the Order Processing service on the ECS cluster is performing in comparison to its service task definition.
- Use CloudWatch alarms to automatically scale in and out the ECS Fargate service tasks based on CPUUtilization and MemoryUtilization metrics.

## ECS Fargate Service - Logging

- Ensure application logs generated by the ECS Fargate Service tasks are published to CloudWatch Logs. This will provide the DevOps team with invaluable data should they need to troubleshoot issues with the processing of messages or saving data to the RDS DB.

## Application Load Balancer - Monitoring

- CloudWatch metrics should be used to monitor the performance of the load balancer.
  - If clients are going to connect to the ALB then some of the metrics that would be useful when monitoring the ALB include: HTTPCode_ELB_4XX_Count &  RequestCount, HTTPCode_ELB_5XX_Count. These will illustrate how many requests the ALB is handling and whether clients are having issues connecting to the ALB
  - TargetResponseTime and UnHealthyHostCount will provide an indication of how the backend Fargate service is performing.

## Application Load Balancer - Logging

- Ensure Access Logs and Connection Logs are enabled for the load balancer. These logs capture detailed information regarding the requests and connections handled by the load balancer and can be used to analyse traffic patterns and assist with troubleshooting. These logs are sent to S3 for long term storage. To prevent logs from accumulating and increasing infrastructure costs, a lifecycle rule can be set up on the S3 bucket to automatically delete these files after a specified period.

---

## Security Risks and Mitigations

What follows is an analysis of the security risks exposed by the architecture and potential mitigations.

- Unrestricted access to the AWS Account housing the Order Processing service is a security risk. As a security best practise, restrict access to the account to essential personnel, such as those required to log into the account to analyse logs, dashboards, perform service modifications or incident remediation.
  - AWS Root account access to the account should be prohibited.
  - IAM User access keys should be restricted to Azure DevOps build pipelines use only.
  - Configure [Federated IAM Roles via Identify Providers](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers.html) for employee access to the account.
    - If IAM user access must be used by employees they should be configured with MFA.
- Follow the principle of least privilege and ensure all IAM Users and IAM roles used by AWS services, resources & employees are restricted via IAM policies to only access the AWS API actions they need on the resources they interact with.
- There is a risk that plaintext Credit Card, Customer or Employee data may leak beyond the boundary of the system. As such, ensure all AWS services and resources that comprise the Order Processing system (RDS database, SQS queue and Amazon ECS ephemeral storage) are configured to encrypt data in transit and data at rest.
  - Encrypt data in transit using SSL/TLS.
  - Encrypting data at rest using KMS or Customer Managed Keys.
- There is a risk that the RDS database credentials are leaked and used maliciously to gain access to customer data. To mitigate this risk:
  - Try to avoid using a database password altogether by relying on [RDS DB IAM authentication](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/UsingWithRDS.IAMDBAuth.html) if within [service limitations](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/UsingWithRDS.IAMDBAuth.html#UsingWithRDS.IAMDBAuth.Limitations).
  - If a password must be used, then store the database password separately in AWS Secrets Manager and configured for automatic rotation.
- There is a risk that the system is made available on the public internet due to misconfiguration. Ensure the VPC is configured with private subnets where the Load Balancer, ECS Fargate Containers and RDS run. Restrict network access to these private subnets via Network Access Control lists and Security Groups.
  